version: "3.8"

services:
  influxdb:
    image: influxdb:2.7-alpine
    restart: unless-stopped

    # ✅ Best practice: non esporre DB su tutte le interfacce
    # Se ti serve accesso remoto, lo fai via SSH tunnel o reverse proxy autenticato.
    ports:
      - "${EDGE_INFLUX_BIND_ADDR}:${EDGE_INFLUX_PORT_HOST}:8086"

    environment:
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=${EDGE_INFLUX_INIT_USERNAME}
      - DOCKER_INFLUXDB_INIT_PASSWORD=${EDGE_INFLUX_INIT_PASSWORD}
      - DOCKER_INFLUXDB_INIT_ORG=${EDGE_INFLUX_ORG}
      - DOCKER_INFLUXDB_INIT_BUCKET=${EDGE_INFLUX_BUCKET}
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=${EDGE_INFLUX_ADMIN_TOKEN}

    volumes:
      - influxdb-data:/var/lib/influxdb2
      - influxdb-config:/etc/influxdb2

    networks:
      - edge-net

    healthcheck:
      test: ["CMD", "influx", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'

  telegraf:
    image: telegraf:1.29-alpine
    restart: unless-stopped
    depends_on:
      influxdb:
        condition: service_healthy
    env_file:
      - ./.env

    # ✅ Hardened: rimosso network_mode host → bridge con mount /proc,/sys read-only.
    # pid: host necessario per metriche CPU/system accurate.
    pid: host

    environment:
      - HOST_PROC=/host/proc
      - HOST_SYS=/host/sys
      - HOST_ETC=/host/etc

    volumes:
      - ./telegraf.conf:/etc/telegraf/telegraf.conf:ro
      - ./certs:/certs:ro
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /etc:/host/etc:ro

    networks:
      - edge-net

    healthcheck:
      test: ["CMD", "pgrep", "telegraf"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.25'

  grafana:
    image: grafana/grafana:10.2.3
    restart: unless-stopped
    depends_on:
      influxdb:
        condition: service_healthy

    # ✅ UI esposta su Tailscale (bind configurabile via EDGE_GRAFANA_BIND_ADDR)
    ports:
      - "${EDGE_GRAFANA_BIND_ADDR}:${EDGE_GRAFANA_PORT_HOST}:3000"

    environment:
      - GF_SECURITY_ADMIN_USER=${EDGE_GRAFANA_ADMIN_USER}
      - GF_SECURITY_ADMIN_PASSWORD=${EDGE_GRAFANA_ADMIN_PASSWORD}
      # (opzionale) riduce possibilità di signup/abusi se un giorno esponi grafana
      - GF_USERS_ALLOW_SIGN_UP=false

    volumes:
      - grafana-data:/var/lib/grafana
      - ./provisioning:/etc/grafana/provisioning:ro

    networks:
      - edge-net

    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3000/api/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'

volumes:
  influxdb-data:
  influxdb-config:
  grafana-data:

networks:
  edge-net:
    driver: bridge
