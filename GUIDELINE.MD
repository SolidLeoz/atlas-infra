# ðŸŽ™ï¸ **DESIGN COMPLETO: ATLAS VOICE ASSISTANT**

---

## ðŸ“ **ARCHITETTURA DETTAGLIATA**

### **1. COMPONENTI SISTEMA**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ATLAS-LAB (Central Brain)                          â”‚
â”‚                    ${ATLAS_LAB_TS_IP} - Ubuntu + GPU 4060Ti                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚              CONTAINER: atlas-voice-engine                      â”‚ â”‚
â”‚  â”‚  Port: 8000 (API), Network: atlas-net                          â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚  1. MQTT Subscriber (voice/+/audio/request)                     â”‚ â”‚
â”‚  â”‚     â†“ riceve audio Base64 da Atlas Mobile                             â”‚ â”‚
â”‚  â”‚                                                                  â”‚ â”‚
â”‚  â”‚  2. Whisper STT (faster-whisper + CUDA)                         â”‚ â”‚
â”‚  â”‚     â†“ audio â†’ text transcription                                â”‚ â”‚
â”‚  â”‚     Model: whisper-large-v3 (GPU accelerated)                   â”‚ â”‚
â”‚  â”‚                                                                  â”‚ â”‚
â”‚  â”‚  3. Command Parser + LLM (Ollama llama3.2:3b)                   â”‚ â”‚
â”‚  â”‚     â†“ text â†’ structured command                                 â”‚ â”‚
â”‚  â”‚     Extract: intent, target, parameters                         â”‚ â”‚
â”‚  â”‚                                                                  â”‚ â”‚
â”‚  â”‚  4. Action Executor                                             â”‚ â”‚
â”‚  â”‚     â”œâ”€ Query InfluxDB (metriche real-time)                      â”‚ â”‚
â”‚  â”‚     â”œâ”€ Publish MQTT commands (control devices)                  â”‚ â”‚
â”‚  â”‚     â”œâ”€ Query Docker (container status)                          â”‚ â”‚
â”‚  â”‚     â””â”€ System commands (via subprocess)                         â”‚ â”‚
â”‚  â”‚                                                                  â”‚ â”‚
â”‚  â”‚  5. Response Generator (LLM + templates)                        â”‚ â”‚
â”‚  â”‚     â†“ risultato â†’ risposta naturale italiana                    â”‚ â”‚
â”‚  â”‚                                                                  â”‚ â”‚
â”‚  â”‚  6. Piper TTS (it-IT voice)                                     â”‚ â”‚
â”‚  â”‚     â†“ text â†’ audio WAV                                          â”‚ â”‚
â”‚  â”‚                                                                  â”‚ â”‚
â”‚  â”‚  7. MQTT Publisher (voice/+/audio/response)                     â”‚ â”‚
â”‚  â”‚     â†“ invia audio Base64 a Atlas Mobile                               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚              CONTAINER: atlas-ollama                            â”‚ â”‚
â”‚  â”‚  Port: 11434, GPU: enabled, Model: llama3.2:3b                  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚              EXISTING: Mosquitto MQTT Broker                     â”‚ â”‚
â”‚  â”‚  Port: 1883 (local), 8883 (TLS)                                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ATLAS-CORE (Edge Hub)                               â”‚
â”‚                    ${ATLAS_CORE_TS_IP} - Ubuntu 24.04                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  EXISTING: InfluxDB + Telegraf + Grafana                         â”‚ â”‚
â”‚  â”‚  - Fornisce dati per query vocali                               â”‚ â”‚
â”‚  â”‚  - Endpoint: ${EDGE_INFLUX_URL_TELEGRAF} (InfluxDB)             â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  NUOVO: atlas-data-api                                          â”‚ â”‚
â”‚  â”‚  Port: 8001                                                      â”‚ â”‚
â”‚  â”‚  - REST API per query InfluxDB semplificate                     â”‚ â”‚
â”‚  â”‚  - Endpoints: /metrics/{device}/{type}                          â”‚ â”‚
â”‚  â”‚  - Cache 5s per ridurre latenza                                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ATLAS-MOBILE (Voice Interface)                             â”‚
â”‚                    ${ATLAS_MOBILE_TS_IP} - Android + Termux                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚              atlas-mobile-client.py                             â”‚ â”‚
â”‚  â”‚  Python 3.11 in Termux                                           â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚  1. Wake Word Detection (PocketSphinx)                           â”‚ â”‚
â”‚  â”‚     Keyword: "Atlas" o "Hey Atlas"                            â”‚ â”‚
â”‚  â”‚     â†“ attiva registrazione                                       â”‚ â”‚
â”‚  â”‚                                                                  â”‚ â”‚
â”‚  â”‚  2. Audio Recorder (PyAudio)                                     â”‚ â”‚
â”‚  â”‚     â†“ registra 5s dopo wake word                                â”‚ â”‚
â”‚  â”‚     Format: WAV 16kHz mono                                       â”‚ â”‚
â”‚  â”‚                                                                  â”‚ â”‚
â”‚  â”‚  3. Audio Encoder                                                â”‚ â”‚
â”‚  â”‚     â†“ WAV â†’ Base64                                              â”‚ â”‚
â”‚  â”‚                                                                  â”‚ â”‚
â”‚  â”‚  4. MQTT Publisher                                               â”‚ â”‚
â”‚  â”‚     Topic: voice/atlas-mobile/audio/request                           â”‚ â”‚
â”‚  â”‚     Payload: {audio: "base64...", user_id: "atlas-mobile"}           â”‚ â”‚
â”‚  â”‚     QoS: 1, TLS: enabled                                         â”‚ â”‚
â”‚  â”‚                                                                  â”‚ â”‚
â”‚  â”‚  5. MQTT Subscriber                                              â”‚ â”‚
â”‚  â”‚     Topic: voice/atlas-mobile/audio/response                          â”‚ â”‚
â”‚  â”‚     â†“ riceve risposta audio + text                              â”‚ â”‚
â”‚  â”‚                                                                  â”‚ â”‚
â”‚  â”‚  6. Audio Player (simpleaudio)                                   â”‚ â”‚
â”‚  â”‚     â†“ Base64 â†’ WAV â†’ play via speaker                           â”‚ â”‚
â”‚  â”‚                                                                  â”‚ â”‚
â”‚  â”‚  7. UI Termux (optional)                                         â”‚ â”‚
â”‚  â”‚     - Status LED (listening/processing/speaking)                â”‚ â”‚
â”‚  â”‚     - Text transcript display                                    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ðŸ”„ **FLUSSO COMPLETO CONVERSAZIONE**

```
1. UTENTE PARLA
   "Atlas, qual Ã¨ la temperatura del server?"
   
   â†“ [Atlas Mobile mic]
   
2. WAKE WORD DETECTION
   Keyword "Atlas" detected â†’ START recording
   
   â†“ [Record 5s audio]
   
3. ENCODE & PUBLISH
   audio.wav â†’ base64 â†’ MQTT
   Topic: voice/atlas-mobile/audio/request
   
   â†“ [MQTTS over Tailscale]
   
4. ATLAS-LAB RICEVE
   atlas-voice-engine subscribe
   
   â†“ [Decode Base64]
   
5. SPEECH-TO-TEXT (Whisper)
   audio â†’ "Qual Ã¨ la temperatura del server?"
   Tempo: ~1-2s (GPU accelerated)
   
   â†“ [Text extracted]
   
6. COMMAND PARSING (LLM)
   Prompt to Ollama:
   """
   Sei un assistente che estrae comandi strutturati.
   Input: "Qual Ã¨ la temperatura del server?"
   Output JSON:
   {
     "intent": "query_metric",
     "target": "atlas-core",
     "metric": "temperature",
     "action": "get_current_value"
   }
   """
   Tempo: ~500ms
   
   â†“ [Structured command]
   
7. ACTION EXECUTION
   a) Query InfluxDB via REST API:
      GET http://${ATLAS_CORE_TS_IP}:8001/metrics/atlas-core/temperature
      
   b) Response: {"value": 42.5, "unit": "celsius", "timestamp": "..."}
   
   Tempo: ~100ms
   
   â†“ [Data retrieved]
   
8. RESPONSE GENERATION (LLM)
   Prompt to Ollama:
   """
   Genera risposta naturale italiana:
   Query: temperatura server
   Result: 42.5Â°C
   Stile: assistente intelligente
   """
   
   Output: "La temperatura del server Ã¨ di 42 gradi e mezzo."
   Tempo: ~300ms
   
   â†“ [Response text]
   
9. TEXT-TO-SPEECH (Piper)
   text â†’ audio.wav (voce italiana femminile)
   Tempo: ~500ms
   
   â†“ [Audio generated]
   
10. ENCODE & PUBLISH
    audio.wav â†’ base64 â†’ MQTT
    Topic: voice/atlas-mobile/audio/response
    Payload: {
      "audio": "base64...",
      "text": "La temperatura del server...",
      "metadata": {...}
    }
    
    â†“ [MQTTS over Tailscale]
    
11. ATLAS-MOBILE RICEVE
    atlas-mobile-client subscribe
    
    â†“ [Decode Base64]
    
12. PLAY AUDIO
    base64 â†’ WAV â†’ speaker output
    
    â†“ [Audio played]
    
13. UTENTE ASCOLTA
    "La temperatura del server Ã¨ di 42 gradi e mezzo."

TEMPO TOTALE: ~3-4 secondi
```

---

## ðŸ“Š **TOPIC MQTT STRUCTURE**

```
atlas/
â”œâ”€â”€ voice/
â”‚   â”œâ”€â”€ atlas-mobile/
â”‚   â”‚   â”œâ”€â”€ audio/
â”‚   â”‚   â”‚   â”œâ”€â”€ request          # Atlas Mobile â†’ Atlas Lab (audio queries)
â”‚   â”‚   â”‚   â””â”€â”€ response         # Atlas Lab â†’ Atlas Mobile (audio replies)
â”‚   â”‚   â”œâ”€â”€ status               # Atlas Mobile status (online/offline)
â”‚   â”‚   â””â”€â”€ config               # Runtime config updates
â”‚   â”‚
â”‚   â””â”€â”€ commands/                # Direct commands (non-voice)
â”‚       â”œâ”€â”€ restart/+
â”‚       â”œâ”€â”€ status/+
â”‚       â””â”€â”€ action/+
â”‚
â”œâ”€â”€ devices/
â”‚   â”œâ”€â”€ atlas-mobile/
â”‚   â”‚   â”œâ”€â”€ telemetry            # EXISTING: battery, sensors
â”‚   â”‚   â””â”€â”€ sensors/#
â”‚   â”‚
â”‚   â”œâ”€â”€ atlas-field/telemetry           # EXISTING: system metrics
â”‚   â”œâ”€â”€ atlas-lab/telemetry    # EXISTING: system metrics
â”‚   â””â”€â”€ atlas-core/telemetry    # system metrics + gateway sensors
â”‚
â””â”€â”€ system/
    â”œâ”€â”€ alerts/#                 # System-wide alerts
    â”œâ”€â”€ health/#                 # Health checks
    â””â”€â”€ logs/#                   # Centralized logging
```

---

## ðŸ—„ï¸ **DATI NECESSARI PER INTEGRAZIONE**

### **A. MQTT Broker (Atlas Lab)**
```yaml
Broker:
  Host: ${ATLAS_LAB_TS_IP}
  Port TLS: 8883
  Port Local: 1883
  
Certificati esistenti:
  - CA: ~/mqtt-certs/ca.crt
  - Atlas Lab: ~/mqtt-certs/atlas-lab.{crt,key}
  
Nuovi certificati da generare:
  - atlas-engine: per voice-engine container
  - atlas-mobile-voice: per client vocale (separato da atlas-mobile telemetria)

Topics da sottoscrivere (voice-engine):
  - voice/+/audio/request
  - atlas/commands/#
  
Topics da pubblicare (voice-engine):
  - voice/+/audio/response
  - atlas/system/alerts/#
```

### **B. InfluxDB (Atlas Core)**
```yaml
Database:
  Host: ${ATLAS_CORE_TS_IP}:8086
  Org: ${EDGE_INFLUX_ORG}
  Bucket: telemetry
  Token: ${EDGE_INFLUX_GRAFANA_TOKEN} (read)
  
Measurements disponibili:
  - cpu (fields: usage_active, usage_idle, ...)
  - mem (fields: used_percent, available, ...)
  - disk (fields: used_percent, free, ...)
  - temp (fields: temp, sensor tag)
  - system (fields: load1, load5, load15, uptime)
  - sensors (device=atlas-core: temperature, cpu_usage)

Query patterns comuni:
  1. Current value:
     from(bucket: "telemetry")
       |> range(start: -1m)
       |> filter(fn: (r) => r["device"] == "X")
       |> filter(fn: (r) => r["_measurement"] == "Y")
       |> filter(fn: (r) => r["_field"] == "Z")
       |> last()
  
  2. Average last 5min:
     |> range(start: -5m)
     |> mean()
  
  3. Max/Min last hour:
     |> range(start: -1h)
     |> max() / min()
```

### **C. Docker Networks (Atlas Lab)**
```yaml
Network: bridge (default)
  - atlas-voice-engine
  - atlas-ollama
  - mosquitto (giÃ  esistente)

Volumes:
  - whisper-models: /models (cache modelli Whisper)
  - piper-voices: /voices (voci TTS italiane)
  - ollama-models: /root/.ollama (modelli LLM)
  
GPU Access:
  - device: /dev/nvidia0
  - runtime: nvidia
  - NVIDIA_VISIBLE_DEVICES: all
```

### **D. Atlas Mobile (Termux)**
```yaml
Packages Termux:
  - python (3.11)
  - portaudio (per PyAudio)
  - openssl (per MQTT TLS)
  - ffmpeg (codec audio)

Python packages:
  - paho-mqtt
  - pyaudio
  - pocketsphinx (wake word)
  - simpleaudio (playback)
  - base64 (stdlib)

Certificati:
  - ca.crt: ~/atlas-mobile/certs/
  - atlas-mobile-voice.crt
  - atlas-mobile-voice.key

Config file: ~/atlas-mobile/config.yaml
  mqtt:
    broker: ${ATLAS_LAB_TS_IP}
    port: 8883
    client_id: ${ATLAS_MOBILE_VOICE_CLIENT_ID}
    username: ${ATLAS_MOBILE_VOICE_USERNAME}
  audio:
    wake_word: atlas
    sample_rate: 16000
    channels: 1
    record_duration: 5
```

---

## ðŸŽ¯ **COMANDI VOCALI SUPPORTATI (MVP)**

### **1. QUERY METRICHE**
```
"Atlas, temperatura del server"
"Atlas, quanta CPU sta usando atlas-lab"
"Atlas, memoria disponibile su atlas-field"
"Atlas, carico sistema atlas-core"
"Atlas, spazio disco atlas-lab"
"Atlas, uptime di tutti i device"
```

### **2. CONTROLLO DISPOSITIVI**
```
"Atlas, riavvia gateway"
"Atlas, stato container su atlas-core"
"Atlas, spegni Grafana"
"Atlas, avvia InfluxDB"
```

### **3. INFORMAZIONI SISTEMA**
```
"Atlas, quanti device sono online"
"Atlas, mostrami gli alert attivi"
"Atlas, quando Ã¨ stato l'ultimo backup"
"Atlas, connessione MQTT funziona"
```

### **4. AUTOMAZIONI**
```
"Atlas, notificami se CPU supera 80%"
"Atlas, crea report giornaliero temperature"
"Atlas, alert se disco < 10GB"
```

---

## ðŸ“¦ **FILE STRUCTURE PROGETTO**

```
~/atlas-infra/
â”œâ”€â”€ atlas-lab/
â”‚   â””â”€â”€ atlas-agent-lab/
â”‚       â”œâ”€â”€ docker-compose.yml
â”‚       â”œâ”€â”€ telegraf.conf
â”‚       â””â”€â”€ certs/
â”œâ”€â”€ atlas-core/
â”‚   â”œâ”€â”€ edge-hub/
â”‚   â”‚   â”œâ”€â”€ docker-compose.yml
â”‚   â”‚   â”œâ”€â”€ telegraf.conf.template
â”‚   â”‚   â”œâ”€â”€ provisioning/
â”‚   â”‚   â””â”€â”€ render-runtime-config.sh
â”‚   â”œâ”€â”€ atlas-agent-core/
â”‚   â”‚   â”œâ”€â”€ docker-compose.yml
â”‚   â”‚   â”œâ”€â”€ telegraf.conf.template
â”‚   â”‚   â””â”€â”€ render-runtime-config.sh
â”‚   â”œâ”€â”€ iot-gateway/
â”‚   â”‚   â”œâ”€â”€ Dockerfile
â”‚   â”‚   â”œâ”€â”€ app.py
â”‚   â”‚   â””â”€â”€ config/
â”‚   â””â”€â”€ mosquitto/
â”‚       â”œâ”€â”€ atlas.conf.template
â”‚       â””â”€â”€ render-mosquitto-config.sh
â”œâ”€â”€ atlas-field/
â”‚   â””â”€â”€ atlas-agent-field/            # Telegraf agent (host remoto)
â””â”€â”€ atlas-mobile/
    â”œâ”€â”€ atlas-mobile/                # Telemetry client (Termux)
    â””â”€â”€ atlas-mobile-client/         # Voice client (wake word)
```

---

## ðŸ” **SECURITY CONSIDERATIONS**

1. **MQTT TLS mutual auth**: Tutti i client autenticati con certificati X.509
2. **Audio encryption**: Audio base64 in MQTT payload (giÃ  criptato da TLS)
3. **API authentication**: Data API con token bearer
4. **Command validation**: LLM output validato prima di esecuzione
5. **Rate limiting**: Max 10 comandi vocali/minuto per prevenire abuse
6. **Logging**: Tutti i comandi loggati per audit
7. **Secrets & indirizzi**: Tutti i valori sensibili e gli indirizzi sono in `.env` centrale (non committato); i template usano `envsubst`.
8. **Least privilege**: Token Influx separati (read/write) e ACL MQTT opzionali per topic.

---

## âš¡ **PERFORMANCE TARGETS**

- **Latenza totale**: < 4 secondi (wake word â†’ risposta audio)
- **Whisper STT**: < 2s (con GPU)
- **LLM parsing**: < 500ms
- **Data query**: < 100ms
- **TTS generation**: < 500ms
- **Network latency**: < 200ms (MQTT roundtrip)

---

## ðŸ“ˆ **MONITORING & OBSERVABILITY**

Metriche da tracciare:
- Latenza end-to-end per comando
- Accuracy Whisper (word error rate)
- LLM command parsing success rate
- MQTT message delivery rate
- GPU utilization (atlas-lab)
- Audio quality metrics

Dashboard Grafana dedicata per voice system.

---

# ðŸŽ™ï¸ **FOICE ASSISTANT ATLAS-LIKE**

Trasformiamo lo Atlas Mobile in interfaccia vocale per controllare l'infrastruttura.

---

## ðŸŽ¯ **ARCHITETTURA VOICE ASSISTANT**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           ATLAS-LAB (AI Brain - GPU 4060Ti)            â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Whisper   â”‚â†’ â”‚ LLM Command  â”‚â†’ â”‚ Action Engine   â”‚ â”‚
â”‚  â”‚ (STT GPU)  â”‚  â”‚  Parser      â”‚  â”‚ (MQTT Commands) â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚         â–²                                    â”‚           â”‚
â”‚         â”‚ audio                              â”‚ response  â”‚
â”‚         â”‚                                    â–¼           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚    TTS     â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  Response Gen   â”‚ â”‚
â”‚  â”‚  (Piper)   â”‚    text response   â”‚  (Ollama/GPT)   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â–²                                    â”‚
         â”‚ MQTT audio                         â”‚ MQTT response
         â”‚                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ATLAS-MOBILE (Voice Interface)                   â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   Mic   â”‚â†’ â”‚  Record  â”‚â†’ â”‚ MQTT Publish Audio   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ MQTT Subscribe   â”‚â†’ â”‚  Play    â”‚â†’ â”‚   Speaker    â”‚ â”‚
â”‚  â”‚ Audio Response   â”‚  â”‚  Audio   â”‚  â”‚              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ðŸ“‹ **PIANO IMPLEMENTAZIONE**

### **STEP 1: Atlas Lab - Setup AI Stack** (30 min)
- Whisper per Speech-to-Text (GPU accelerated)
- Ollama con Llama 3.2 per command parsing
- Piper TTS per risposte vocali
- MQTT bridge per audio streaming

### **STEP 2: Atlas Mobile - Voice Client** (20 min)
- Termux app con Python
- PyAudio per registrazione
- MQTT client per pub/sub audio
- Audio player per risposte

### **STEP 3: Command Engine** (30 min)
- Parser comandi vocali â†’ azioni MQTT
- Esempi:
  - "Atlas, temperatura server?" â†’ query InfluxDB
  - "Atlas, riavvia gateway" â†’ docker restart
  - "Atlas, CPU atlas-lab?" â†’ real-time stats

---

# ðŸ“ **STRUTTURA COMPLETA FILE SYSTEM - STATO ATTUALE**

---

## ðŸ–¥ï¸ **ATLAS-LAB (${ATLAS_LAB_TS_IP})**

### **Sistema**
- **OS**: Ubuntu (versione da verificare)
- **GPU**: NVIDIA GeForce RTX 4060 Ti 16GB
- **RAM**: 32GB
- **User**: `leoz`

### **Struttura Filesystem**

```
/home/leoz/
â”‚
â”œâ”€â”€ mqtt-certs/                           # Certificati MQTT X.509
â”‚   â”œâ”€â”€ ca.crt                           # Certificate Authority (2004 bytes)
â”‚   â”œâ”€â”€ ca.key                           # CA private key
â”‚   â”œâ”€â”€ ca.srl                           # CA serial
â”‚   â”œâ”€â”€ broker.crt                       # Broker cert (NON USATO - broker su atlas-core)
â”‚   â”œâ”€â”€ broker.key                       # Broker key (NON USATO)
â”‚   â”œâ”€â”€ atlas-field.crt                         # Client cert per laptop atlas-field (1651 bytes)
â”‚   â”œâ”€â”€ atlas-field.key                         # Client key per atlas-field (1704 bytes)
â”‚   â”œâ”€â”€ atlas-field.csr                         # Certificate signing request
â”‚   â”œâ”€â”€ atlas-lab.crt                  # Client cert per atlas-lab (1717 bytes)
â”‚   â”œâ”€â”€ atlas-lab.key                  # Client key per atlas-lab (1704 bytes)
â”‚   â”œâ”€â”€ atlas-lab.csr                  # CSR atlas-lab
â”‚   â”œâ”€â”€ atlas-core.crt             # Client cert per atlas-core (1651 bytes)
â”‚   â”œâ”€â”€ atlas-core.key             # Client key (1704 bytes)
â”‚   â””â”€â”€ atlas-core.csr             # CSR atlas-core
â”‚
â”œâ”€â”€ atlas-agent-lab/            # Telegraf Agent per atlas-lab
â”‚   â”œâ”€â”€ docker-compose.yml               # Container config
â”‚   â”‚   services:
â”‚   â”‚     - telegraf (image: telegraf:1.29-alpine)
â”‚   â”‚       container_name: atlas-agent-lab
â”‚   â”‚       network_mode: host
â”‚   â”‚
â”‚   â”œâ”€â”€ telegraf.conf                    # Telegraf configuration
â”‚   â”‚   [agent]
â”‚   â”‚     hostname: ${ATLAS_LAB_AGENT_TELEGRAF_HOSTNAME}
â”‚   â”‚     interval: 10s
â”‚   â”‚   [[inputs.cpu]]
â”‚   â”‚   [[inputs.mem]]
â”‚   â”‚   [[inputs.disk]]
â”‚   â”‚   [[inputs.system]]
â”‚   â”‚   [[inputs.temp]]
â”‚   â”‚   [[outputs.mqtt]]
â”‚   â”‚     servers: ${ATLAS_LAB_AGENT_MQTT_URL}
â”‚   â”‚     topic: devices/${ATLAS_LAB_AGENT_DEVICE_ID}/telemetry
â”‚   â”‚     data_format: influx
â”‚   â”‚     tls_ca: /certs/ca.crt
â”‚   â”‚     tls_cert: /certs/atlas-lab.crt
â”‚   â”‚     tls_key: /certs/atlas-lab.key
â”‚   â”‚
â”‚   â”œâ”€â”€ telegraf.conf.bak                # Backup config
â”‚   â””â”€â”€ certs/                           # Certificati montati in container
â”‚       â”œâ”€â”€ ca.crt
â”‚       â”œâ”€â”€ atlas-lab.crt
â”‚       â””â”€â”€ atlas-lab.key
â”‚
â””â”€â”€ (MQTT Broker rimosso - ora su atlas-core)

```

### **Container Docker Attivi**
```bash
CONTAINER ID   NAME                        STATUS
xxxxxxxxxx     atlas-agent-lab    Up (running)
```

### **Network Info**
```yaml
Tailscale IP: ${ATLAS_LAB_TS_IP}
Hostname: atlas-lab
Network: Tailscale mesh
```

### **Servizi Attivi**
- Telegraf agent (porta pubblicazione MQTT TLS a atlas-core)

---

## ðŸ–¥ï¸ **ATLAS-CORE (${ATLAS_CORE_TS_IP})**

### **Sistema**
- **OS**: Ubuntu 24.04
- **Hardware**: Server-grade (dettagli da verificare)
- **User**: `leoz`

### **Struttura Filesystem**

```
/home/leoz/
â”‚
â”œâ”€â”€ atlas-infra/atlas-core/edge-hub/     # Hub centrale IoT
â”‚   â”œâ”€â”€ docker-compose.yml               # InfluxDB + Grafana + Telegraf collector
â”‚   â”‚   version: '3.8'
â”‚   â”‚   services:
â”‚   â”‚     influxdb:
â”‚   â”‚     telegraf:
â”‚   â”‚     grafana:
â”‚   â”‚   # Mosquitto gira via systemd (non in docker-compose)
â”‚   â”œâ”€â”€ telegraf.conf                    # Telegraf central config
â”‚   â”‚   [agent]
â”‚   â”‚     hostname: ${EDGE_TELEGRAF_HOSTNAME}
â”‚   â”‚     interval: 10s
â”‚   â”‚   [[inputs.mqtt_consumer]]
â”‚   â”‚     servers: ${EDGE_MQTT_URL}
â”‚   â”‚     topics:
â”‚   â”‚       - devices/+/telemetry
â”‚   â”‚       - devices/+/sensors/#
â”‚   â”‚     data_format: influx
â”‚   â”‚   [[processors.regex]]
â”‚   â”‚     [[processors.regex.tags]]
â”‚   â”‚       key: topic
â”‚   â”‚       pattern: ^devices/([^/]+)/.*
â”‚   â”‚       result_key: device
â”‚   â”‚   [[outputs.influxdb_v2]]
â”‚   â”‚     urls: ${EDGE_INFLUX_URL_TELEGRAF}
â”‚   â”‚     token: ${EDGE_INFLUX_TELEGRAF_TOKEN}
â”‚   â”‚     organization: ${EDGE_INFLUX_ORG}
â”‚   â”‚     bucket: ${EDGE_INFLUX_BUCKET}
â”‚   â”‚
â”‚   â””â”€â”€ README.md
â”‚
â”œâ”€â”€ iot-gateway/                         # Gateway locale atlas-core
â”‚   â”œâ”€â”€ docker-compose.yml
â”‚   â”‚   services:
â”‚   â”‚     iot-gateway:
â”‚   â”‚       build: .
â”‚   â”‚       container_name: iot-gateway
â”‚   â”‚       network_mode: host
â”‚   â”‚
â”‚   â”œâ”€â”€ Dockerfile
â”‚   â”‚   FROM python:3.11-slim
â”‚   â”‚   RUN pip install paho-mqtt psutil pyyaml
â”‚   â”‚   CMD ["python", "/app/app.py"]
â”‚   â”‚
â”‚   â”œâ”€â”€ app.py                           # Gateway application
â”‚   â”‚   - Legge sensori (temp, CPU) via psutil
â”‚   â”‚   - Pubblica su MQTT in Line Protocol format
â”‚   â”‚   - Topic: ${GATEWAY_MQTT_TELEMETRY_TOPIC}
â”‚   â”‚   - Connessione: ${GATEWAY_MQTT_BROKER_HOST}:${GATEWAY_MQTT_BROKER_PORT} (non-TLS)
â”‚   â”‚   - Intervallo: 6s (configurabile via MQTT command)
â”‚   â”‚
â”‚   â”œâ”€â”€ app.py.bak                       # Backup versione JSON
â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â””â”€â”€ gateway.yaml
â”‚   â”‚       mqtt:
â”‚   â”‚         broker: ${GATEWAY_MQTT_BROKER_HOST}
â”‚   â”‚         port: ${GATEWAY_MQTT_BROKER_PORT}
â”‚   â”‚         client_id: ${GATEWAY_MQTT_CLIENT_ID}
â”‚   â”‚         topics:
â”‚   â”‚           telemetry: ${GATEWAY_MQTT_TELEMETRY_TOPIC}
â”‚   â”‚           commands: ${GATEWAY_MQTT_COMMANDS_TOPIC}
â”‚   â”‚       sensors:
â”‚   â”‚         temperature:
â”‚   â”‚           interval: 6
â”‚   â”‚       logging:
â”‚   â”‚         level: ${GATEWAY_LOG_LEVEL}
â”‚   â”‚         file: ${GATEWAY_LOG_FILE}
â”‚   â”‚
â”‚   â”œâ”€â”€ logs/
â”‚   â”‚   â””â”€â”€ gateway.log
â”‚   â”œâ”€â”€ requirements.txt
â”‚   â”œâ”€â”€ broker.csr
â”‚   â”œâ”€â”€ broker.key
â”‚   â”œâ”€â”€ certs/
â”‚   â””â”€â”€ README.md
â”‚
â”œâ”€â”€ atlas-agent-core/            # Telegraf Agent atlas-core
â”‚   â”œâ”€â”€ docker-compose.yml
â”‚   â”‚   services:
â”‚   â”‚     telegraf:
â”‚   â”‚       image: telegraf:1.29-alpine
â”‚   â”‚       container_name: atlas-agent-core
â”‚   â”‚       network_mode: host
â”‚   â”‚
â”‚   â”œâ”€â”€ telegraf.conf
â”‚   â”‚   [agent]
â”‚   â”‚     hostname: ${ATLAS_CORE_AGENT_TELEGRAF_HOSTNAME}
â”‚   â”‚   [[outputs.mqtt]]
â”‚   â”‚     servers: ${ATLAS_CORE_AGENT_MQTT_URL}
â”‚   â”‚     topic: devices/${ATLAS_CORE_AGENT_DEVICE_ID}/telemetry
â”‚   â”‚     data_format: influx
â”‚   â”‚
â”‚   â”œâ”€â”€ telegraf.conf.bak
â”‚   â””â”€â”€ certs/
â”‚       â”œâ”€â”€ ca.crt
â”‚       â”œâ”€â”€ atlas-core.crt
â”‚       â””â”€â”€ atlas-core.key
â”‚
â””â”€â”€ (altri progetti esistenti)

```

### **System Files**

```
/etc/mosquitto/
â”œâ”€â”€ mosquitto.conf                       # Main config
â”‚   persistence true
â”‚   persistence_location /var/lib/mosquitto/
â”‚   log_dest file /var/log/mosquitto/mosquitto.log
â”‚   log_dest stdout
â”‚   include_dir /etc/mosquitto/conf.d
â”‚
â”œâ”€â”€ conf.d/
â”‚   â””â”€â”€ atlas.conf                      # Atlas-specific config
â”‚       # Listener non-TLS (local only)
â”‚       listener ${MOSQUITTO_PLAIN_PORT} ${MOSQUITTO_PLAIN_BIND_ADDR}
â”‚       allow_anonymous true
â”‚       
â”‚       # Listener TLS (external)
â”‚       listener ${MOSQUITTO_TLS_PORT} ${MOSQUITTO_TLS_BIND_ADDR}
â”‚       cafile ${MOSQUITTO_CAFILE}
â”‚       certfile ${MOSQUITTO_CERTFILE}
â”‚       keyfile ${MOSQUITTO_KEYFILE}
â”‚       require_certificate true
â”‚       use_identity_as_username true
â”‚       allow_anonymous false
â”‚       acl_file ${MOSQUITTO_ACL_FILE}  # optional
â”‚
â””â”€â”€ certs/
    â”œâ”€â”€ ca.crt                           # CA certificate
    â”œâ”€â”€ broker.crt                       # Broker cert (CN=${ATLAS_CORE_TS_IP})
    â””â”€â”€ broker.key                       # Broker private key
    Permissions: mosquitto:mosquitto, 644 for .crt, 600 for .key

/var/log/mosquitto/
â””â”€â”€ mosquitto.log                        # Broker logs
```

### **Container Docker Attivi**
```bash
CONTAINER ID   NAME                        STATUS
# mosquitto e gestito via systemd (non container)
xxxxxxxxxx     edge-hub-telegraf-1         Up
xxxxxxxxxx     edge-hub-influxdb-1         Up (port 8086)
xxxxxxxxxx     edge-hub-grafana-1          Up (port 3001)
xxxxxxxxxx     iot-gateway                 Up (optional)
xxxxxxxxxx     atlas-agent-core            Up
```

### **InfluxDB Data**
```yaml
Organization: ${EDGE_INFLUX_ORG}
Bucket: telemetry
  - Retention: infinite
  - ID: 94499a39ccb4a7ee

Tokens:
  - ${EDGE_INFLUX_ADMIN_TOKEN} (admin, bootstrap only)
  - ${EDGE_INFLUX_TELEGRAF_TOKEN} (write: telemetry)
  - ${EDGE_INFLUX_GRAFANA_TOKEN} (read: telemetry)

Measurements:
  - cpu (from all agents)
  - mem (from all agents)
  - disk (from all agents)
  - system (from all agents)
  - temp (from all agents)
  - sensors (from gateway atlas-core)
  - mobile_battery (from atlas-mobile)
  - mobile_telemetry (from atlas-mobile)

Devices:
  - atlas-field
  - atlas-lab
  - atlas-core
  - atlas-mobile
```

### **Grafana**
```yaml
URL: http://${ATLAS_CORE_TS_IP}:3001 (MagicDNS: http://atlas-core:3001/)
Credentials:
  - Username: ${EDGE_GRAFANA_ADMIN_USER}
  - Password: ${EDGE_GRAFANA_ADMIN_PASSWORD}

Data Sources:
  - InfluxDB-Telemetry
    URL: ${EDGE_INFLUX_URL_GRAFANA}
    Token: ${EDGE_INFLUX_GRAFANA_TOKEN}
    Organization: ${EDGE_INFLUX_ORG}
    Bucket: ${EDGE_INFLUX_BUCKET}

Dashboards:
  - Atlas Overview
  - Atlas Device Detail
```

### **Network Info**
```yaml
Tailscale IP: ${ATLAS_CORE_TS_IP}
Hostname: atlas-core
Services:
  - Mosquitto: 1883 (local only), 8883 (TLS all interfaces)
  - InfluxDB: 8086
  - Grafana: 3001
```

---

## ðŸ’» **LAPTOP ATLAS-FIELD (${ATLAS_FIELD_TS_IP})**

### **Sistema**
- **OS**: Ubuntu (fascia bassa)
- **User**: `user`

### **Struttura Filesystem**

```
/home/user/
â”‚
â””â”€â”€ atlas-agent-field/                   # Telegraf Agent
    â”œâ”€â”€ docker-compose.yml
    â”‚   version: '3.8'
    â”‚   services:
    â”‚     telegraf:
    â”‚       image: telegraf:1.29-alpine
    â”‚       container_name: atlas-agent-field
    â”‚       network_mode: host
    â”‚
    â”œâ”€â”€ telegraf.conf
    â”‚   [agent]
    â”‚     hostname: ${ATLAS_FIELD_AGENT_TELEGRAF_HOSTNAME}
    â”‚     interval: 10s
    â”‚   [[inputs.cpu]]
    â”‚   [[inputs.mem]]
    â”‚   [[inputs.disk]]
    â”‚   [[inputs.system]]
    â”‚   [[inputs.temp]]
    â”‚   [[outputs.mqtt]]
    â”‚     servers: ${ATLAS_FIELD_AGENT_MQTT_URL}
    â”‚     topic: devices/${ATLAS_FIELD_AGENT_DEVICE_ID}/telemetry
    â”‚     client_id: ${ATLAS_FIELD_AGENT_DEVICE_ID}-telegraf
    â”‚     data_format: influx
    â”‚     tls_ca: /certs/ca.crt
    â”‚     tls_cert: /certs/atlas-field.crt
    â”‚     tls_key: /certs/atlas-field.key
    â”‚
    â”œâ”€â”€ telegraf.conf.bak
    â””â”€â”€ certs/
        â”œâ”€â”€ ca.crt                       # 2004 bytes
        â”œâ”€â”€ atlas-field.crt                     # 1651 bytes
        â””â”€â”€ atlas-field.key                     # 1704 bytes
```

### **Container Docker Attivi**
```bash
CONTAINER ID   NAME                STATUS
xxxxxxxxxx     atlas-agent-field   Up
```

### **Docker Setup**
- User aggiunto a gruppo docker: `usermod -aG docker user`
- Permessi corretti applicati

### **Network Info**
```yaml
Tailscale IP: ${ATLAS_FIELD_TS_IP}
Hostname: atlas-field
```

---

## ðŸ“± **ATLAS-MOBILE (${ATLAS_MOBILE_TS_IP})**

### **Sistema**
- **OS**: Android + Termux
- **App**: Termux (terminal Linux su Android)

### **Struttura Filesystem**

```
/data/data/com.termux/files/home/
â”‚
â””â”€â”€ atlas-mobile/                       # Client MQTT telemetria mobile
    â”œâ”€â”€ config.yaml
    â”‚   mqtt:
    â”‚     broker: ${ATLAS_MOBILE_MQTT_BROKER_HOST}
    â”‚     port: ${ATLAS_MOBILE_MQTT_BROKER_PORT}
    â”‚     client_id: ${ATLAS_MOBILE_MQTT_CLIENT_ID}
    â”‚     username: ${ATLAS_MOBILE_MQTT_USERNAME}
    â”‚     password: ${ATLAS_MOBILE_MQTT_PASSWORD}
    â”‚     topics:
    â”‚       telemetry: ${ATLAS_MOBILE_MQTT_TELEMETRY_TOPIC}
    â”‚       commands: ${ATLAS_MOBILE_MQTT_COMMANDS_TOPIC}
    â”‚       sensors:
    â”‚         battery: ${ATLAS_MOBILE_MQTT_SENSORS_BATTERY_TOPIC}
    â”‚         location: ${ATLAS_MOBILE_MQTT_SENSORS_LOCATION_TOPIC}
    â”‚         sensor: ${ATLAS_MOBILE_MQTT_SENSORS_SENSOR_TOPIC}
    â”‚   sensors:
    â”‚     interval: ${ATLAS_MOBILE_SENSORS_INTERVAL}
    â”‚   logging:
    â”‚     level: INFO
    â”‚
    â”œâ”€â”€ mobile_sensors.py                # MQTT + Termux sensors + comandi
    â”‚   - Legge batteria via Termux API
    â”‚   - Pubblica Influx line protocol:
    â”‚     - mobile_battery (sensors/battery)
    â”‚     - mobile_telemetry (telemetry)
    â”‚   - Sottoscrive ${ATLAS_MOBILE_MQTT_COMMANDS_TOPIC}
    â”‚
    â””â”€â”€ certs/
        â”œâ”€â”€ ca.crt
        â”œâ”€â”€ atlas-mobile.crt             # Certificato client
        â””â”€â”€ atlas-mobile.key
```

### **Termux Packages Installati**
```bash
- python (3.11)
- termux-api (per accesso sensori Android)
- openssl (per TLS)
```

### **Python Packages**
```bash
- paho-mqtt
- pyyaml
```

### **Stato Client**
```yaml
Status: Gestito da Termux Boot (start-atlas.sh)
MQTT Connection:
  - Broker: ${ATLAS_MOBILE_MQTT_BROKER_HOST}:${ATLAS_MOBILE_MQTT_BROKER_PORT}
  - TLS: enabled
  - Authentication: X.509 certificate (CN=atlas-mobile)
  - Connected: Yes (log mosquitto mostra "New client connected from ${ATLAS_MOBILE_TS_IP}")
```

### **Network Info**
```yaml
Tailscale IP: ${ATLAS_MOBILE_TS_IP}
Hostname: atlas-mobile (o simile)
Connection: Mobile (LTE/WiFi via Tailscale)
```

---

## ðŸ” **CERTIFICATI X.509 - RIEPILOGO**

### **Certificate Authority (CA)**
```yaml
Location: atlas-lab:~/mqtt-certs/ca.crt
  - Common Name: Atlas Lab CA
  - Valid: 365 days
  - Used by: tutti i client per verificare broker e peers
```

### **Broker Certificate**
```yaml
Location: atlas-core:/etc/mosquitto/certs/broker.crt
  - Common Name: ${ATLAS_CORE_TS_IP}
  - SAN: IP:${ATLAS_CORE_TS_IP}
  - Used by: Mosquitto broker su porta 8883
```

### **Client Certificates**
```yaml
1. atlas-field
   Location: atlas-field:~/atlas-agent-field/certs/atlas-field.crt
   CN: atlas-field
   Used by: Telegraf agent atlas-field
   MQTT username: atlas-field (from CN)

2. atlas-lab
   Location: atlas-lab:~/atlas-agent-lab/certs/atlas-lab.crt
   CN: atlas-lab
   Used by: Telegraf agent atlas-lab
   MQTT username: atlas-lab

3. atlas-core
   Location: atlas-core:~/atlas-agent-core/certs/atlas-core.crt
   CN: atlas-core
   Used by: Telegraf agent atlas-core
   MQTT username: atlas-core

4. mobile (atlas-mobile)
   Location: atlas-mobile:~/atlas-mobile/certs/atlas-mobile.crt
   CN: atlas-mobile
   Used by: Python MQTT client su Atlas Mobile
   MQTT username: atlas-mobile
```

---

## ðŸ“Š **MQTT TOPICS - STATO ATTUALE**

```
devices/
â”œâ”€â”€ atlas-field/
â”‚   â””â”€â”€ telemetry                        # Line Protocol (Telegraf)
â”‚       Frequency: 10s
â”‚       Measurements: cpu, mem, disk, system, temp
â”‚
â”œâ”€â”€ atlas-lab/
â”‚   â””â”€â”€ telemetry                        # Line Protocol (Telegraf)
â”‚       Frequency: 10s
â”‚       Measurements: cpu, mem, disk, system, temp
â”‚
â”œâ”€â”€ atlas-core/
â”‚   â”œâ”€â”€ telemetry                        # Line Protocol (Telegraf + Gateway)
â”‚   â”‚   Frequency: 6-10s
â”‚   â”‚   Measurements: cpu, mem, disk, system, temp, sensors
â”‚   â””â”€â”€ commands                         # Commands to gateway
â”‚       Payload: {"action": "set_interval", "value": X}
â”‚
â””â”€â”€ atlas-mobile/
    â”œâ”€â”€ sensors/
    â”‚   â””â”€â”€ battery                      # Line Protocol (mobile_battery)
    â”‚       Frequency: 10s
    â”‚       Measurements: percentage, temperature
    â””â”€â”€ telemetry                        # Line Protocol (mobile_telemetry + system)
        Frequency: 10s
        Measurements:
          - mobile_telemetry: iteration, battery_percent, battery_temp
          - cpu: usage_active
          - mem: used_percent
          - disk: used_percent (tag: path)
          - system: uptime, load1
          - temp: temp (tag: sensor=battery)
```

---

## ðŸŒ **NETWORK TOPOLOGY**

```
Tailscale Mesh Network (100.x.x.x/10)
â”‚
â”œâ”€â”€ ${ATLAS_LAB_TS_IP} (atlas-lab)
â”‚   Services: Telegraf Agent
â”‚   Outbound: MQTT TLS â†’ atlas-core:8883
â”‚
â”œâ”€â”€ ${ATLAS_CORE_TS_IP} (atlas-core)
â”‚   Services:
â”‚     - Mosquitto MQTT Broker (1883 local, 8883 TLS)
â”‚     - InfluxDB (8086)
â”‚     - Grafana (3001)
â”‚     - Telegraf Central (consume MQTT â†’ InfluxDB)
â”‚     - Gateway (publish sensors)
â”‚     - Telegraf Agent (publish metrics)
â”‚   Inbound:
â”‚     - MQTT TLS 8883 â† all devices
â”‚     - HTTP 8086 â† Grafana
â”‚     - HTTP 3001 â† users
â”‚
â”œâ”€â”€ ${ATLAS_FIELD_TS_IP} (atlas-field)
â”‚   Services: Telegraf Agent
â”‚   Outbound: MQTT TLS â†’ atlas-core:8883
â”‚
â””â”€â”€ ${ATLAS_MOBILE_TS_IP} (atlas-mobile)
    Services: Python MQTT Client
    Outbound: MQTT TLS â†’ atlas-core:8883
```

---

## ðŸ“¦ **VOLUMI DOCKER**

### **Atlas Core**
```yaml
Volumes:
  - influxdb-data: /var/lib/docker/volumes/edge-hub_influxdb-data
    Size: ~varios MB (time-series data)
    Contains: InfluxDB bucket data
  
  - influxdb-config: /var/lib/docker/volumes/edge-hub_influxdb-config
    Contains: InfluxDB configuration
  
  - grafana-data: /var/lib/docker/volumes/edge-hub_grafana-data
    Contains: Grafana dashboards, users, datasources
```

---

## ðŸ” **COMANDI UTILI PER VERIFICA**

### **Atlas Lab**
```bash
# Verifica agent
sudo docker ps | grep atlas-lab
sudo docker logs atlas-agent-lab --tail=20

# Verifica certificati
ls -lh ~/mqtt-certs/
openssl x509 -in ~/mqtt-certs/atlas-lab.crt -text -noout
```

### **Atlas Core**
```bash
# Verifica stack
cd ~/atlas-infra/atlas-core/edge-hub
docker compose ps
docker compose logs -f

# Verifica Mosquitto
sudo tail -f /var/log/mosquitto/mosquitto.log
mosquitto_sub -h ${ATLAS_CORE_TS_IP} -p 1883 -t "devices/#" -v

# Verifica InfluxDB
docker exec -it edge-hub-influxdb-1 influx bucket list --org ${EDGE_INFLUX_ORG}
docker exec -it edge-hub-influxdb-1 influx query 'from(bucket:"telemetry") |> range(start:-5m) |> limit(n:10)' --org ${EDGE_INFLUX_ORG} --token ${EDGE_INFLUX_GRAFANA_TOKEN}

# Verifica certificati broker
ls -lh /etc/mosquitto/certs/
sudo openssl x509 -in /etc/mosquitto/certs/broker.crt -text -noout
```

### **ATLAS-FIELD**
```bash
# Verifica agent
docker ps | grep atlas-field
docker logs atlas-agent-field --tail=20
```

### **Atlas Mobile (Termux)**
```bash
# Verifica processo
ps aux | grep mqtt
# Verifica log (se loggato)
tail -f ~/atlas-mobile/mqtt.log
```

---

**Questa Ã¨ la struttura completa e attuale. Vuoi che procediamo con l'implementazione del voice assistant o hai bisogno di altre verifiche?**
